<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" />

    <!-- Generated with Sphinx 7.3.7 and Furo 2024.05.06 -->
        <title>das4whales.data_handle - DAS4Whales documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=387cc868" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=fd3f3429" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=36a5483c" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  --color-brand-primary: #005f73;
  --color-brand-content: #0a9396;
  --color-background-primary: #ffffff;
  --color-background-secondary: #e0fbfc;
  --color-foreground-primary: #023047;
  --color-foreground-secondary: #8ecae6;
  --color-link: #ffb703;
  --color-link--hover: #fb8500;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #0a9396;
  --color-brand-content: #94d2bd;
  --color-background-primary: #001219;
  --color-background-secondary: #003049;
  --color-foreground-primary: #e0fbfc;
  --color-foreground-secondary: #94d2bd;
  --color-link: #ffb703;
  --color-link--hover: #fb8500;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #0a9396;
  --color-brand-content: #94d2bd;
  --color-background-primary: #001219;
  --color-background-secondary: #003049;
  --color-foreground-primary: #e0fbfc;
  --color-foreground-secondary: #94d2bd;
  --color-link: #ffb703;
  --color-link--hover: #fb8500;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" /
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">DAS4Whales  documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  
  <span class="sidebar-brand-text">DAS4Whales  documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../src/install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../src/tutorial.html">Tutorial</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Modules documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/das4whales.html">das4whales package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../src/data_handle.html">data_handle</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../src/dsp.html">dsp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../src/detect.html">detect</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../src/plot.html">plot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../src/graph.html">Graph of Modules and Functions</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <h1>Source code for das4whales.data_handle</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">data_handle.py - data handling functions for DAS data</span>

<span class="sd">This module provides various functions to handle DAS data, including loading, downloading, and conditioning. </span>
<span class="sd">It aims at having specific functions for each interrogator type.</span>

<span class="sd">Authors: LÃ©a Bouffaut, Quentin Goestchel, Erfan Horeh</span>
<span class="sd">Date: 2023-2024</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">import</span> <span class="nn">wget</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">dask.array</span> <span class="k">as</span> <span class="nn">da</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timezone</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">nptdms</span> <span class="kn">import</span> <span class="n">TdmsFile</span>


<div class="viewcode-block" id="hello_world_das_package">
<a class="viewcode-back" href="../../src/data_handle.html#das4whales.data_handle.hello_world_das_package">[docs]</a>
<span class="k">def</span> <span class="nf">hello_world_das_package</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Yepee! You now have access to all the functionalities of the das4whale python package!&quot;</span><span class="p">)</span></div>



<span class="c1"># Definition of the functions for DAS data conditioning</span>
<div class="viewcode-block" id="get_acquisition_parameters">
<a class="viewcode-back" href="../../src/data_handle.html#das4whales.data_handle.get_acquisition_parameters">[docs]</a>
<span class="k">def</span> <span class="nf">get_acquisition_parameters</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">interrogator</span><span class="o">=</span><span class="s1">&#39;optasense&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve acquisition parameters based on the specified interrogator.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filepath : str</span>
<span class="sd">        The file path to the data file.</span>
<span class="sd">    interrogator : str, optional</span>
<span class="sd">        The interrogator type, one of {&#39;optasense&#39;, &#39;silixa&#39;, &#39;mars&#39;, &#39;alcatel&#39;}.</span>
<span class="sd">        Defaults to &#39;optasense&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    metadata : dict or None</span>
<span class="sd">        Metadata related to the acquisition parameters. Returns None if no matching</span>
<span class="sd">        interrogator is found.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If the interrogator name is not in the predefined list.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># List the known used interrogators:</span>
    <span class="n">interrogator_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;optasense&#39;</span><span class="p">,</span> <span class="s1">&#39;silixa&#39;</span><span class="p">,</span> <span class="s1">&#39;mars&#39;</span><span class="p">,</span> <span class="s1">&#39;alcatel&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">interrogator</span> <span class="ow">in</span> <span class="n">interrogator_list</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">interrogator</span> <span class="o">==</span> <span class="s1">&#39;optasense&#39;</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">get_metadata_optasense</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">interrogator</span> <span class="o">==</span> <span class="s1">&#39;silixa&#39;</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">get_metadata_silixa</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">interrogator</span> <span class="o">==</span> <span class="s1">&#39;mars&#39;</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">get_metadata_mars</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">interrogator</span> <span class="o">==</span> <span class="s1">&#39;alcatel&#39;</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">get_metadata_alcatel</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Interrogator name incorrect&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">metadata</span></div>



<div class="viewcode-block" id="get_metadata_optasense">
<a class="viewcode-back" href="../../src/data_handle.html#das4whales.data_handle.get_metadata_optasense">[docs]</a>
<span class="k">def</span> <span class="nf">get_metadata_optasense</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gets DAS acquisition parameters for the optasense interrogator </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filepath : string</span>
<span class="sd">        a string containing the full path to the data to load</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    metadata : dict</span>
<span class="sd">        dictionary filled with metadata, key&#39;s breakdown:\n</span>
<span class="sd">        fs: the sampling frequency (Hz)\n</span>
<span class="sd">        dx: interval between two virtual sensing points also called channel spacing (m)\n</span>
<span class="sd">        nx: the number of spatial samples also called channels\n</span>
<span class="sd">        ns: the number of time samples\n</span>
<span class="sd">        n: refractive index of the fiber\n</span>
<span class="sd">        GL: the gauge length (m)\n</span>
<span class="sd">        scale_factor: the value to convert DAS data from strain rate to strain</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Make sure the file exists</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
        <span class="c1"># Ensure the closure of the file after reading</span>
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp1</span><span class="p">:</span>
            <span class="n">fp1</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>

            <span class="n">fs</span> <span class="o">=</span> <span class="n">fp1</span><span class="p">[</span><span class="s1">&#39;Acquisition&#39;</span><span class="p">][</span><span class="s1">&#39;Raw[0]&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;OutputDataRate&#39;</span><span class="p">]</span> <span class="c1"># sampling rate in Hz</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="n">fp1</span><span class="p">[</span><span class="s1">&#39;Acquisition&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;SpatialSamplingInterval&#39;</span><span class="p">]</span> <span class="c1"># channel spacing in m</span>
            <span class="n">ns</span> <span class="o">=</span> <span class="n">fp1</span><span class="p">[</span><span class="s1">&#39;Acquisition&#39;</span><span class="p">][</span><span class="s1">&#39;Raw[0]&#39;</span><span class="p">][</span><span class="s1">&#39;RawDataTime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Count&#39;</span><span class="p">]</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">fp1</span><span class="p">[</span><span class="s1">&#39;Acquisition&#39;</span><span class="p">][</span><span class="s1">&#39;Custom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Fibre Refractive Index&#39;</span><span class="p">]</span> <span class="c1"># refractive index</span>
            <span class="n">GL</span> <span class="o">=</span> <span class="n">fp1</span><span class="p">[</span><span class="s1">&#39;Acquisition&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;GaugeLength&#39;</span><span class="p">]</span> <span class="c1"># gauge length in m</span>
            <span class="n">nx</span> <span class="o">=</span> <span class="n">fp1</span><span class="p">[</span><span class="s1">&#39;Acquisition&#39;</span><span class="p">][</span><span class="s1">&#39;Raw[0]&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;NumberOfLoci&#39;</span><span class="p">]</span> <span class="c1"># number of channels</span>
            <span class="n">scale_factor</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">16</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1550.12</span> <span class="o">*</span> <span class="mf">1e-9</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">0.78</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">n</span> <span class="o">*</span> <span class="n">GL</span><span class="p">)</span>

        <span class="n">meta_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fs&#39;</span><span class="p">:</span> <span class="n">fs</span><span class="p">,</span> <span class="s1">&#39;dx&#39;</span><span class="p">:</span> <span class="n">dx</span><span class="p">,</span> <span class="s1">&#39;ns&#39;</span><span class="p">:</span> <span class="n">ns</span><span class="p">,</span><span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="n">n</span><span class="p">,</span><span class="s1">&#39;GL&#39;</span><span class="p">:</span> <span class="n">GL</span><span class="p">,</span> <span class="s1">&#39;nx&#39;</span><span class="p">:</span><span class="n">nx</span> <span class="p">,</span> <span class="s1">&#39;scale_factor&#39;</span><span class="p">:</span> <span class="n">scale_factor</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;File </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s1"> not found&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">meta_data</span></div>



<div class="viewcode-block" id="get_metadata_silixa">
<a class="viewcode-back" href="../../src/data_handle.html#das4whales.data_handle.get_metadata_silixa">[docs]</a>
<span class="k">def</span> <span class="nf">get_metadata_silixa</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gets DAS acquisition parameters for the silixa interrogator </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filepath : string</span>
<span class="sd">        a string containing the full path to the data to load</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    metadata : dict</span>
<span class="sd">        dictionary filled with metadata, key&#39;s breakdown:\n</span>
<span class="sd">        fs: the sampling frequency (Hz)\n</span>
<span class="sd">        dx: interval between two virtual sensing points also called channel spacing (m)\n</span>
<span class="sd">        nx: the number of spatial samples also called channels\n</span>
<span class="sd">        ns: the number of time samples\n</span>
<span class="sd">        n: refractive index of the fiber\n</span>
<span class="sd">        GL: the gauge length (m)\n</span>
<span class="sd">        scale_factor: the value to convert DAS data from strain rate to strain</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Make sure the file exists</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">TdmsFile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="n">props</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">properties</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">fp</span><span class="p">[</span><span class="s1">&#39;Measurement&#39;</span><span class="p">]</span>
        <span class="n">acousticData</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span> <span class="p">[</span><span class="n">group</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">group</span><span class="p">]</span> <span class="p">)</span>

        <span class="n">fs</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="s1">&#39;SamplingFrequency[Hz]&#39;</span><span class="p">]</span> <span class="c1"># sampling rate in Hz</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="s1">&#39;SpatialResolution[m]&#39;</span><span class="p">]</span> <span class="c1"># channel spacing in m</span>
        <span class="n">ns</span> <span class="o">=</span> <span class="n">acousticData</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">n</span> <span class="o">=</span>  <span class="n">props</span><span class="p">[</span><span class="s1">&#39;FibreIndex&#39;</span><span class="p">]</span> <span class="c1"># refractive index</span>
        <span class="n">GL</span> <span class="o">=</span>  <span class="n">props</span><span class="p">[</span><span class="s1">&#39;GaugeLength&#39;</span><span class="p">]</span> <span class="c1"># gauge length in m</span>
        <span class="n">nx</span> <span class="o">=</span> <span class="n">acousticData</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># number of channels</span>
        <span class="n">scale_factor</span> <span class="o">=</span> <span class="p">(</span><span class="mi">116</span> <span class="o">*</span> <span class="n">fs</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">9</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">GL</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="mi">13</span><span class="p">)</span>

        <span class="n">meta_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fs&#39;</span><span class="p">:</span> <span class="n">fs</span><span class="p">,</span> <span class="s1">&#39;dx&#39;</span><span class="p">:</span> <span class="n">dx</span><span class="p">,</span> <span class="s1">&#39;ns&#39;</span><span class="p">:</span> <span class="n">ns</span><span class="p">,</span><span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="n">n</span><span class="p">,</span><span class="s1">&#39;GL&#39;</span><span class="p">:</span> <span class="n">GL</span><span class="p">,</span> <span class="s1">&#39;nx&#39;</span><span class="p">:</span><span class="n">nx</span> <span class="p">,</span> <span class="s1">&#39;scale_factor&#39;</span><span class="p">:</span> <span class="n">scale_factor</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;File </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s1"> not found&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">meta_data</span></div>



<div class="viewcode-block" id="raw2strain">
<a class="viewcode-back" href="../../src/data_handle.html#das4whales.data_handle.raw2strain">[docs]</a>
<span class="k">def</span> <span class="nf">raw2strain</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transform the amplitude of raw das data from strain-rate to strain according to scale factor</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    trace : array-like</span>
<span class="sd">        a [channel x time sample] nparray containing the raw data in the spatio-temporal domain</span>
<span class="sd">    metadata : dict</span>
<span class="sd">        dictionary filled with metadata (fs, dx, nx, ns, n, GL, scale_factor)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    trace : array-like</span>
<span class="sd">        a [channel x time sample] nparray containing the strain data in the spatio-temporal domain</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="c1"># Remove the mean trend from each channel and scale</span>

    <span class="n">trace</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">trace</span> <span class="o">*=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;scale_factor&quot;</span><span class="p">]</span> 
    <span class="k">return</span> <span class="n">trace</span></div>



<div class="viewcode-block" id="load_das_data">
<a class="viewcode-back" href="../../src/data_handle.html#das4whales.data_handle.load_das_data">[docs]</a>
<span class="k">def</span> <span class="nf">load_das_data</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">selected_channels</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load the DAS data corresponding to the input file name as strain according to the selected channels.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        A string containing the full path to the data to load.</span>
<span class="sd">    selected_channels : list</span>
<span class="sd">        A list containing the selected channels.</span>
<span class="sd">    metadata : dict</span>
<span class="sd">        A dictionary filled with metadata (sampling frequency, channel spacing, scale factor...).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    trace : np.ndarray</span>
<span class="sd">        A [channel x sample] nparray containing the strain data.</span>
<span class="sd">    tx : np.ndarray</span>
<span class="sd">        The corresponding time axis (s).</span>
<span class="sd">    dist : np.ndarray</span>
<span class="sd">        The corresponding distance along the FO cable axis (m).</span>
<span class="sd">    file_begin_time_utc : datetime.datetime</span>
<span class="sd">        The beginning time of the file, can be printed using file_begin_time_utc.strftime(&quot;%Y-%m-%d %H:%M:%S&quot;).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;File </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1"> not found&#39;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="c1"># Data matrix</span>
        <span class="n">raw_data</span> <span class="o">=</span> <span class="n">fp</span><span class="p">[</span><span class="s1">&#39;Acquisition/Raw[0]/RawData&#39;</span><span class="p">]</span>

        <span class="c1"># Selection the traces corresponding to the desired channels</span>
        <span class="c1"># Loaded as float64, float 32 might be sufficient? </span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">raw_data</span><span class="p">[</span><span class="n">selected_channels</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">selected_channels</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="n">selected_channels</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">raw2strain</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>

        <span class="c1"># UTC Time vector for naming</span>
        <span class="n">raw_data_time</span> <span class="o">=</span> <span class="n">fp</span><span class="p">[</span><span class="s1">&#39;Acquisition&#39;</span><span class="p">][</span><span class="s1">&#39;Raw[0]&#39;</span><span class="p">][</span><span class="s1">&#39;RawDataTime&#39;</span><span class="p">]</span>

        <span class="c1"># For future save</span>
        <span class="n">file_begin_time_utc</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">(</span><span class="n">raw_data_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">)</span>

        <span class="c1"># Store the following as the dimensions of our data block</span>
        <span class="n">nnx</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nns</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Define new time and distance axes</span>
        <span class="n">tx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nns</span><span class="p">)</span> <span class="o">/</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;fs&quot;</span><span class="p">]</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nnx</span><span class="p">)</span> <span class="o">*</span> <span class="n">selected_channels</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">selected_channels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;dx&quot;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">trace</span><span class="p">,</span> <span class="n">tx</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">file_begin_time_utc</span></div>



<div class="viewcode-block" id="load_mtpl_das_data">
<a class="viewcode-back" href="../../src/data_handle.html#das4whales.data_handle.load_mtpl_das_data">[docs]</a>
<span class="k">def</span> <span class="nf">load_mtpl_das_data</span><span class="p">(</span><span class="n">filepaths</span><span class="p">,</span> <span class="n">selected_channels</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">time_window</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load the DAS data corresponding to the input file names as strain according to the selected channels. Takes multiple files as input and concatenates them along the time axis starting from the input timestamp for the input time window.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filepaths : list</span>
<span class="sd">        A list containing the full pathes to the data to load.</span>
<span class="sd">    selected_channels : list</span>
<span class="sd">        A list containing the selected channels.</span>
<span class="sd">    metadata : dict</span>
<span class="sd">        A dictionary filled with metadata (sampling frequency, channel spacing, scale factor...).</span>
<span class="sd">    timestamp : str</span>
<span class="sd">        The timestamp to extract the data from.</span>
<span class="sd">    time_window : float</span>
<span class="sd">        The time window duration to extract the data from.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    trace : np.ndarray</span>
<span class="sd">        A [channel x sample] nparray containing the strain data.</span>
<span class="sd">    tx : np.ndarray</span>
<span class="sd">        The corresponding time axis (s).</span>
<span class="sd">    dist : np.ndarray</span>
<span class="sd">        The corresponding distance along the FO cable axis (m).</span>
<span class="sd">    file_begin_time_utc : datetime.datetime</span>
<span class="sd">        The beginning time of the file, can be printed using file_begin_time_utc.strftime(&quot;%Y-%m-%d %H:%M:%S&quot;).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Print the input timestamp</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;timestamp_input: </span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="c1"># Convert timestamp to microseconds since epoch</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
    <span class="n">timestamp_us</span> <span class="o">=</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1e6</span>

    <span class="n">trace</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">file_begin_time_utc</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="c1"># Loop through each filepath lazily</span>
    <span class="k">for</span> <span class="n">filepath</span> <span class="ow">in</span> <span class="n">filepaths</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;File </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s1"> not found&#39;</span><span class="p">)</span>
        
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">raw_data</span> <span class="o">=</span> <span class="n">fp</span><span class="p">[</span><span class="s1">&#39;Acquisition/Raw[0]/RawData&#39;</span><span class="p">]</span>
            <span class="n">raw_data_time</span> <span class="o">=</span> <span class="n">fp</span><span class="p">[</span><span class="s1">&#39;Acquisition/Raw[0]/RawDataTime&#39;</span><span class="p">]</span>

            <span class="c1"># Select the traces corresponding to the desired channels lazily</span>
            <span class="n">selected_trace</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="n">selected_channels</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">selected_channels</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="n">selected_channels</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">:],</span> <span class="n">chunks</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
            
            <span class="c1"># Find the index where raw_data_time &gt;= timestamp lazily</span>
            <span class="k">if</span> <span class="n">trace</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">raw_data_time</span><span class="p">,</span> <span class="n">timestamp_us</span><span class="p">)</span>
                <span class="n">file_begin_time_utc</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">raw_data_time</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
            
            <span class="c1"># Concatenate traces along the time axis lazily</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">selected_trace</span> <span class="k">if</span> <span class="n">trace</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">da</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">trace</span><span class="p">,</span> <span class="n">selected_trace</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Convert the time window duration to samples</span>
    <span class="n">duration_samples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time_window</span> <span class="o">*</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;fs&quot;</span><span class="p">])</span>
    
    <span class="c1"># Extract the desired time window lazily</span>
    <span class="n">trace</span> <span class="o">=</span> <span class="n">trace</span><span class="p">[:,</span> <span class="n">index</span><span class="p">:</span><span class="n">index</span> <span class="o">+</span> <span class="n">duration_samples</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="c1"># Convert raw data to strain</span>
    <span class="n">tr</span> <span class="o">=</span> <span class="n">raw2strain</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;timestamp_output: </span><span class="si">{</span><span class="n">file_begin_time_utc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># Get dimensions of the data block lazily</span>
    <span class="n">nnx</span><span class="p">,</span> <span class="n">nns</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">shape</span>
    
    <span class="c1"># Define new time and distance axes lazily</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nns</span><span class="p">)</span> <span class="o">/</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;fs&quot;</span><span class="p">]</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nnx</span><span class="p">)</span> <span class="o">*</span> <span class="n">selected_channels</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">selected_channels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;dx&quot;</span><span class="p">]</span>

    <span class="c1"># Return dask arrays for lazy evaluation</span>
    <span class="k">return</span> <span class="n">tr</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span> <span class="n">time</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">file_begin_time_utc</span></div>



<div class="viewcode-block" id="dl_file">
<a class="viewcode-back" href="../../src/data_handle.html#das4whales.data_handle.dl_file">[docs]</a>
<span class="k">def</span> <span class="nf">dl_file</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Download the file at the given url</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    url : string</span>
<span class="sd">        url location of the file</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    filepath : string</span>
<span class="sd">        local path destination of the file</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">filename</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1"> already stored locally&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Create the data subfolder if it doesn&#39;t exist</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">wget</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">bar</span><span class="o">=</span><span class="n">wget</span><span class="o">.</span><span class="n">bar_adaptive</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Downloaded </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">filename</span></div>



<div class="viewcode-block" id="load_cable_coordinates">
<a class="viewcode-back" href="../../src/data_handle.html#das4whales.data_handle.load_cable_coordinates">[docs]</a>
<span class="k">def</span> <span class="nf">load_cable_coordinates</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">dx</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load the cable coordinates from a text file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filepath : str</span>
<span class="sd">        The file path to the cable coordinates file.</span>
<span class="sd">    dx : float</span>
<span class="sd">        The distance between two channels.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        The cable coordinates dataframe.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># load the .txt file and create a pandas dataframe</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">delimiter</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;chan_idx&#39;</span><span class="p">,</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="s1">&#39;depth&#39;</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;chan_m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;chan_idx&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">dx</span>

    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="calc_dist_to_xidx">
<a class="viewcode-back" href="../../src/data_handle.html#das4whales.data_handle.calc_dist_to_xidx">[docs]</a>
<span class="k">def</span> <span class="nf">calc_dist_to_xidx</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">selected_channels_m</span><span class="p">,</span> <span class="n">selected_channels</span><span class="p">,</span> <span class="n">dx</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the index of the channel closest to the given distance.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : float</span>
<span class="sd">        The distance along the cable.</span>
<span class="sd">    selected_channels_m : list</span>
<span class="sd">        The selected channels in meters.</span>
<span class="sd">    selected_channels : list</span>
<span class="sd">        The selected channels.</span>
<span class="sd">    dx : float</span>
<span class="sd">        The distance between two channels.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        The index of the channel closest to the given distance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="n">selected_channels_m</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">dx</span> <span class="o">*</span> <span class="n">selected_channels</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span></div>



<div class="viewcode-block" id="get_selected_channels">
<a class="viewcode-back" href="../../src/data_handle.html#das4whales.data_handle.get_selected_channels">[docs]</a>
<span class="k">def</span> <span class="nf">get_selected_channels</span><span class="p">(</span><span class="n">selected_channels_m</span><span class="p">,</span> <span class="n">dx</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the selected channels in channel numbers.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    selected_channels_m : list</span>
<span class="sd">        The selected channels in meters. [ChannelStart_m, ChannelStop_m, ChannelStep_m]</span>
<span class="sd">    dx : float</span>
<span class="sd">        The distance between two channels.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        The selected channels in channel numbers. [ChannelStart, ChannelStop, ChannelStep]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">selected_channels</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">selected_channels_m</span> <span class="o">//</span> <span class="n">dx</span><span class="p">)</span> <span class="k">for</span> <span class="n">selected_channels_m</span> <span class="ow">in</span>
                     <span class="n">selected_channels_m</span><span class="p">]</span>  <span class="c1"># list of values in channel number (spatial sample) corresponding to the starting, ending and step wanted</span>
                                           <span class="c1"># channels along the FO Cable</span>
                                           <span class="c1"># selected_channels = [ChannelStart, ChannelStop, ChannelStep] in channel</span>
                                           <span class="c1"># numbers</span>
    <span class="k">return</span> <span class="n">selected_channels</span></div>

</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2024, Bouffaut &amp; Goestchel
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=4e2eecee"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    </body>
</html>